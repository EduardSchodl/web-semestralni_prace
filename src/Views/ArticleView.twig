{% extends "BaseView.twig" %}

{% block title %} {{ title }} {% endblock %}

{% block content %}
    <!-- CKEditor textarea initially hidden -->
    <div id="editorWrapper" class="container mt-5">
        <textarea name="editor" id="editor"></textarea>
    </div>

    <div class="container mt-5">
        <!-- Article Header -->
        <div id="headerDiv" class="article-header text-center">
            <h1 id="title" class="display-4">{{ article.title }}</h1>
            <p class="lead">Published on: {{ article.create_time|date('F j, Y') }}</p>
        </div>

        <!-- Article Content -->
        <div id="content" class="row article-content">
            <div class="col-md-8 offset-md-2">
                <p class="text-justify">{{ article.article_content|nl2br }}</p>
            </div>
        </div>

        {% if app.user.id_user == article.id_user %}
            <button id="editSave" onclick="editArticle()" class="btn btn-success" type="button">Edit</button>
        {% endif %}

        <!-- Author Information -->
        <div class="row mb-4">
            <div class="col-md-4 offset-md-4">
                <div class="author-info text-center">
                    <h5>{{ article.first_name }} {{ article.last_name }}</h5>
                    <p>Professor, Department of Computer Science, University XYZ</p>
                    <p>Email: {{ article.email }}</p>
                </div>
            </div>
        </div>

        <!-- Review Section -->
        <div class="review-section">
            <h3 class="text-center">Reviews</h3>
            <div class="row">
                <div class="col-md-6 offset-md-3">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Reviewer 1</h5>
                            <p class="card-text">This is an insightful article that effectively highlights the impact of AI on conferences. However, more detail on data privacy concerns would have been helpful.</p>
                            <p class="card-text"><small class="text-muted">Reviewed on: September 28, 2024</small></p>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Reviewer 2</h5>
                            <p class="card-text">Great topic! The future of conferences is indeed fascinating, and this paper presents some excellent examples of AI in action.</p>
                            <p class="card-text"><small class="text-muted">Reviewed on: September 27, 2024</small></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById("editor").style.display = "none";

        let editorInstance = null;

        // Get the article content and title
        let contentElement = document.getElementById("content");
        let titleElement = document.getElementById("headerDiv");
        let title = document.getElementById("title").textContent;

        function editArticle(){
            if(editorInstance != null){
                return;
            }

            // Switch button text to 'Save'
            let editSaveButton = document.getElementById("editSave");
            editSaveButton.innerText = "Save";
            editSaveButton.addEventListener("click", saveChanges);

            // Hide the current article content and title
            contentElement.style.display = "none";
            titleElement.style.display = "none";

            // Show the CKEditor wrapper
            document.getElementById("editorWrapper").style.display = "block";

            ClassicEditor
                .create(document.querySelector('#editor'), {
                    heading: {
                        options: [
                            { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                            { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                            { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                            { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                        ]
                    }
                })
                .then(editor => {
                    editorInstance = editor;
                    let content = contentElement.getElementsByTagName("p")[0].innerHTML;

                    editorInstance.setData('<h1>' + title + '</h1>' + '<p>' + content + '</p>'); // Set title + content in editor
                    console.log('Editor initialized successfully:', editor);
                })
                .catch(error => {
                    console.error('Error initializing CKEditor:', error);
                });
        }

        function saveChanges(){
            if(!editorInstance){
                return;
            }

            let data = editorInstance.getData();
            data = data.replace(/<br\s*\/?>/gi, '\n');

            let tempDiv = document.createElement("div");
            tempDiv.innerHTML = data;

            let title = tempDiv.querySelector("h1") ? tempDiv.querySelector("h1").innerHTML : "";
            let content = tempDiv.querySelector("p") ? tempDiv.querySelector("p").innerHTML : "";
            alert(content);
            /*
            $.ajax({
                url: 'articles/update',
                method: 'POST',
                data: {
                    title: title,
                    content: content,
                    article_id: {{ article.id_article }}
                },
                success: function(response) {
                    console.log("Article updated successfully.");
                    alert("Article updated!");
                    location.reload();
                },
                error: function(error) {
                    console.error("Error updating article:", error);
                    alert("There was an error updating the article.");
                }
            });
            */
        }
    </script>
{% endblock %}